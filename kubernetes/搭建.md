# Kubernetes 搭建

### 服务器要求

* 3 台服务器（虚拟机）
  * k8s-master：192.168.56.101
  * k8s-node1：192.168.56.102
  * k8s-node2：192.168.56.103
* 最低配置：2核、2G内存、20G硬盘
* 最好能联网，不能联网的话需要有提供对应镜像的私有仓库

### 软件环境

* 操作系统：ubuntu 7
* Docker：20+
* k8s：1.28.0

### 安装步骤

#### 1、初始化操作

```shell
# 1. 关闭Ubuntu默认防火墙ufw（替代CentOS的firewalld）
# 先查看防火墙状态（可选）
sudo ufw status
# 关闭防火墙并禁用开机自启
sudo ufw disable

# 2. 【无需执行】Ubuntu系统默认没有SELinux，直接删除原CentOS的selinux相关命令即可
# （Ubuntu不内置selinux，无需临时关闭或永久禁用，这一步可跳过）

# 3. 关闭swap（临时+永久，命令与CentOS通用）
sudo swapoff -a  # 临时关闭swap
sudo sed -ri 's/.*swap.*/#&/' /etc/fstab  # 永久禁用swap（注释fstab中的swap配置）

# 【重要提醒】关闭swap后，务必重启虚拟机使配置生效
# sudo reboot  # 执行完此部分可先重启，再继续后续命令

# 4. 根据规划设置主机名（替换<hostname>为实际名称，如k8s-master/k8s-node1）
sudo hostnamectl set-hostname <hostname>

# 5. 在master节点添加hosts（IP可替换为你的自定义固定IP，与之前Host-Only配置一致）
cat >> /etc/hosts << EOF
192.168.56.101 k8s-master
192.168.56.102 k8s-node1
192.168.56.103 k8s-node2
EOF

# 6. 将桥接的IPv4流量传递到iptables的链（命令与CentOS通用）
cat > /etc/sysctl.d/k8s.conf << EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF

sudo sysctl --system  # 使sysctl配置立即生效

# 7. 时间同步 启用并配置Ubuntu自带时间同步
sudo timedatectl set-ntp true
sudo timedatectl set-timezone Asia/Shanghai  # 先设置时区（可选，默认可能不是国内时区）
sudo systemctl restart systemd-timesyncd
# 验证时间同步状态
timedatectl status
```

#### 2.安装基础软件（所有节点）

* 2.1 安装 Docker

```shell
# step 1: 安装必要的系统工具（修复原命令字符错误+完整适配）
sudo apt-get update
sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common

# step 2: 安装GPG证书（替换废弃的apt-key，适配新版Ubuntu）
curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/aliyun-docker.gpg

# Step 3: 写入软件源信息（修复字符错误+保留自动识别系统版本）
sudo add-apt-repository "deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable"

# Step 4: 更新并安装Docker-CE
sudo apt-get -y update
sudo apt-get -y install docker-ce

# Step 5: 安转校验
docker version
```

* 2.2 添加阿里云 yum 源

  ```shell
  # 1. 删除旧的无效密钥和源配置
  sudo rm -f /etc/trusted.gpg.d/aliyun-k8s.gpg
  sudo rm -f /etc/apt/sources.list.d/kubernetes.list

  # 2. 重新配置阿里云K8s源+完整密钥
  curl -fsSL https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/aliyun-k8s.gpg
  cat > /etc/apt/sources.list.d/kubernetes.list << EOF
  deb [arch=amd64 signed-by=/etc/apt/trusted.gpg.d/aliyun-k8s.gpg] https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial main
  EOF

  # 3. 更新缓存
  sudo apt-get update -y

  ```
* 2.3 安装 kubeadm、kubelet、kubectl

  ```shell
  # 安装指定版本K8s（替换为你需要的版本，如1.28.0）
  sudo apt-get install -y kubelet=1.30.2-00 kubeadm=1.30.2-00 kubectl=1.30.2-00
  # 锁定K8s版本，防止自动更新
  sudo apt-mark hold kubelet kubeadm kubectl
  ```
* 2.4 验证

  ```shell
  # 1. 验证K8s组件版本
  kubelet --version
  kubeadm version
  kubectl version

  # 2. 验证Docker cgroup驱动配置生效
  docker info | grep "Cgroup Driver"
  # 预期输出：Cgroup Driver: systemd

  # 3. 验证kubelet状态（虽未初始化K8s，但开机自启已配置）
  sudo systemctl status kubelet
  ```

#### 3.部署 Kubernetes Master

```shell
# 安装containerd
sudo apt-get update
sudo apt-get install -y containerd.io

# 生成默认配置文件
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml

# 优化配置（替换pause镜像为阿里云源+启用systemd cgroup驱动）
sudo sed -i 's#sandbox_image = "k8s.gcr.io/pause:3.6"#sandbox_image = "registry.aliyuncs.com/google_containers/pause:3.9"#' /etc/containerd/config.toml
sudo sed -i 's#SystemdCgroup = false#SystemdCgroup = true#' /etc/containerd/config.toml

# 重启并启用containerd
sudo systemctl restart containerd
sudo systemctl enable containerd

# 1. 加载必要内核模块
sudo modprobe bridge
sudo modprobe br_netfilter

# 2. 配置sysctl参数（永久生效）
cat > /etc/sysctl.d/k8s.conf << EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
EOF

# 3. 使sysctl参数立即生效
sudo sysctl --system

# 在 Master 节点下执行
kubeadm init \
--apiserver-advertise-address=192.168.56.101 \
--image-repository registry.aliyuncs.com/google_containers \
--kubernetes-version v1.28.0 \
--service-cidr=10.96.0.0/12 \
--pod-network-cidr=10.244.0.0/16 \
--cri-socket=unix:///run/containerd/containerd.sock

# 安装成功后，复制如下配置并执行
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
kubectl get nodes
```

初始化不成功执行

```shell
# 强制重置K8s，清理所有初始化残留
sudo kubeadm reset -f

# 删除残留的配置文件、证书目录
sudo rm -rf /etc/kubernetes/manifests /etc/kubernetes/pki
sudo rm -rf $HOME/.kube/config
# 查找并终止占用10250端口的进程
sudo lsof -i :10250 | grep LISTEN | awk '{print $2}' | xargs sudo kill -9 2>/dev/null
```

手动拉取

```shell
kubeadm config images pull \
--image-repository registry.aliyuncs.com/google_containers \
--kubernetes-version v1.28.0 \
--cri-socket=unix:///run/containerd/containerd.sock
```

#### 4.加入 Kubernetes Node

```shell
分别在 k8s-node1 和 k8s-node2 执行

# 下方命令可以在 k8s master 控制台初始化成功后复制 join 命令

kubeadm join 192.168.56.101:6443 --token kps5e6.58h3vq6kb6srm9tb \
        --discovery-token-ca-cert-hash sha256:545eb7849bbfa8450854c81e2412fb02be67960b23d52e67f39b17ee688b82eb

# 如果初始化的 token 不小心清空了，可以通过如下命令获取或者重新申请
# 如果 token 已经过期，就重新申请
kubeadm token create

# token 没有过期可以通过如下命令获取
kubeadm token list

# 获取 --discovery-token-ca-cert-hash 值，得到值后需要在前面拼接上 sha256:
openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | \
openssl dgst -sha256 -hex | sed 's/^.* //'
```

#### 5.部署 CNI 网络插件

```shell
# 在 master 节点上执行
# 下载 calico 配置文件，可能会网络超时
curl https://docs.projectcalico.org/manifests/calico.yaml -O

# 修改 calico.yaml 文件中的 CALICO_IPV4POOL_CIDR 配置，修改为与初始化的 cidr 相同

# 修改 IP_AUTODETECTION_METHOD 下的网卡名称

```

#### 6.测试 kubernetes 集群

```shell
# 创建部署
kubectl create deployment nginx --image=nginx

# 暴露端口
kubectl expose deployment nginx --port=80 --type=NodePort

# 查看 pod 以及服务信息
kubectl get pod,svc
```

#### 7.所有节点使用kubectl

```shell
# 1. 将 master 节点中 /etc/kubernetes/admin.conf 拷贝到需要运行的服务器的 /etc/kubernetes 目录中
scp /etc/kubernetes/admin.conf root@k8s-node1:/etc/kubernetes

# 2. 在对应的服务器上配置环境变量
echo "export KUBECONFIG=/etc/kubernetes/admin.conf" >> ~/.bash_profile
source ~/.bash_profile
```
