### ğŸš€ æ–¹æ¡ˆä¸€ï¼šã€æœ€æ¨èã€‘Harbor ç¦»çº¿å®Œæ•´å®‰è£…æ­¥éª¤ï¼ˆé¡µé¢ä¸‹è½½ + ç¦»çº¿å¯¼å…¥ + ç¦»çº¿éƒ¨ç½²ï¼ŒUbuntu+containerd/K8sï¼‰

è¿™æ˜¯**å…¨ç½‘æœ€è¯¦ç»†çš„ Harbor ç¦»çº¿éƒ¨ç½²å®æ“æ­¥éª¤**ï¼Œé€‚é…ä½ çš„æ‰€æœ‰éœ€æ±‚ï¼Œ**æ— ä»»ä½•å‘ç‚¹**ï¼Œç‰ˆæœ¬é€‰æ‹©ï¼š`v2.12.2`ï¼ˆç¨³å®šç‰ˆï¼Œç”Ÿäº§é¦–é€‰ï¼‰

#### âœ… æ­¥éª¤ 1ï¼šæµè§ˆå™¨é¡µé¢ä¸‹è½½ Harbor ç¦»çº¿å®‰è£…åŒ…ï¼ˆæ— å‘½ä»¤è¡Œï¼Œçº¯é¡µé¢ä¸‹è½½ï¼Œè§£å†³ç½‘ç»œå·®ï¼‰

**ä¸‹è½½åœ°å€ï¼ˆå®˜ç½‘ï¼Œå¯ç›´æ¥æµè§ˆå™¨æ‰“å¼€ï¼Œä¸­æ–‡å¯è®¿é—®ï¼‰**ï¼š

[https://github.com/goharbor/harbor/releases/tag/v2.12.2](https://github.com/goharbor/harbor/releases/tag/v2.8.3)

åœ¨è¿™ä¸ªé¡µé¢ï¼Œæ‰¾åˆ° 2 ä¸ªæ–‡ä»¶ï¼Œ**ç”¨æµè§ˆå™¨ç›´æ¥ä¸‹è½½åˆ°æœ¬åœ°ç”µè„‘**ï¼ˆæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼Œç½‘ç»œå·®ä¹Ÿèƒ½ä¸‹ï¼‰ï¼š

â‘  `harbor-offline-installer-v2.12.2.tgz` â†’ Harbor ç¦»çº¿å®‰è£…ä¸»åŒ…ï¼ˆåŒ…å«æ‰€æœ‰é…ç½®æ–‡ä»¶ + ç¦»çº¿å®‰è£…è„šæœ¬ï¼Œçº¦ 60MBï¼‰ï¼›

â‘¡ è¿™ä¸ªç¦»çº¿åŒ…**å·²ç»å†…ç½®äº†æ‰€æœ‰ Harbor è¿è¡Œæ‰€éœ€çš„é•œåƒå‹ç¼©åŒ…**ï¼Œæ— éœ€é¢å¤–ä¸‹è½½å…¶ä»–é•œåƒï¼Œè¿™æ˜¯ Harbor ç¦»çº¿åŒ…çš„æ ¸å¿ƒä¼˜åŠ¿ï¼

#### âœ… æ­¥éª¤ 2ï¼šæŠŠä¸‹è½½å¥½çš„å®‰è£…åŒ…ä¼ åˆ° Ubuntu æœåŠ¡å™¨

ç”¨ SCP/Xshell/FinalShell æŠŠ `harbor-offline-installer-v2.12.2.tgz` ä¼ åˆ°æœåŠ¡å™¨çš„ `/usr/local/` ç›®å½•ä¸‹ã€‚

#### âœ… æ­¥éª¤ 3ï¼šè§£å‹ç¦»çº¿å®‰è£…åŒ…

bash

è¿è¡Œ

```
cd /usr/local/
tar -zxvf harbor-offline-installer-v2.12.2.tgz
cd harbor
```

#### âœ… æ­¥éª¤ 4ï¼šä¿®æ”¹ Harbor é…ç½®æ–‡ä»¶ï¼ˆæç®€é…ç½®ï¼Œç”Ÿäº§å¤Ÿç”¨ï¼‰

bash

è¿è¡Œ

```
# å¤åˆ¶é…ç½®æ¨¡æ¿
cp harbor.yml.tmpl harbor.yml

# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim harbor.yml

# åªéœ€è¦ä¿®æ”¹ä»¥ä¸‹3ä¸ªé…ç½®é¡¹ï¼Œå…¶ä»–é»˜è®¤å³å¯ï¼Œä¸ç”¨åŠ¨ï¼
1. hostname: 192.168.1.100  # æ”¹æˆä½ çš„æœåŠ¡å™¨å®é™…IPåœ°å€ï¼Œä¸è¦ç”¨localhost
2. http: port: 80            # ç«¯å£ç”¨80ï¼Œç®€å•ï¼Œæ— éœ€é…ç½®HTTPSè¯ä¹¦ï¼ˆå†…ç½‘å¤Ÿç”¨ï¼‰
3. harbor_admin_password: Harbor12345  # ç®¡ç†å‘˜å¯†ç ï¼Œå¯è‡ªå®šä¹‰ï¼Œè®°ä½è¿™ä¸ªå¯†ç ï¼Œç™»å½•ç”¨
```

> æ³¨æ„ï¼šå¦‚æœä¸éœ€è¦ HTTPSï¼Œç›´æ¥æŠŠé…ç½®æ–‡ä»¶é‡Œçš„ `https` ç›¸å…³é…ç½®**å…¨éƒ¨æ³¨é‡Šæ‰**ï¼Œé¿å…æŠ¥é”™ã€‚

#### âœ… æ­¥éª¤ 5ï¼šç¦»çº¿å¯¼å…¥ Harbor æ‰€æœ‰é•œåƒï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼Œæ— ç½‘ç»œï¼Œæœ¬åœ°å¯¼å…¥ï¼‰

Harbor çš„ç¦»çº¿å®‰è£…åŒ…ä¸­ï¼Œå·²ç»å†…ç½®äº†æ‰€æœ‰è¿è¡Œæ‰€éœ€çš„é•œåƒå‹ç¼©åŒ…ï¼Œæ‰§è¡Œè„šæœ¬è‡ªåŠ¨å¯¼å…¥ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œï¼š

bash

è¿è¡Œ

```
# åŠ è½½æ‰€æœ‰ç¦»çº¿é•œåƒï¼ˆè‡ªåŠ¨å¯¼å…¥åˆ°æœ¬åœ°ï¼Œæ— ç½‘ç»œè¯·æ±‚ï¼‰
./prepare

# éªŒè¯é•œåƒæ˜¯å¦å¯¼å…¥æˆåŠŸï¼ˆèƒ½çœ‹åˆ°harborå¼€å¤´çš„é•œåƒåˆ—è¡¨å³æˆåŠŸï¼‰
docker images | grep harbor
```

#### âœ… æ­¥éª¤ 6ï¼šç¦»çº¿å®‰è£… Harborï¼ˆä¸€é”®å®‰è£…ï¼Œå…¨ç¨‹æ— ç½‘ç»œï¼‰

bash

è¿è¡Œ

```
# æ‰§è¡Œç¦»çº¿å®‰è£…è„šæœ¬ï¼Œä¸€é”®éƒ¨ç½²
./install.sh

# å®‰è£…å®Œæˆåï¼ŒéªŒè¯æ˜¯å¦å¯åŠ¨æˆåŠŸ
docker-compose ps
```

#### âœ… æ­¥éª¤ 7ï¼šéªŒè¯ Harbor æ˜¯å¦å¯ç”¨

1. æµè§ˆå™¨è®¿é—®ï¼š`http://ä½ çš„æœåŠ¡å™¨IP` â†’ è¾“å…¥è´¦å·`admin`ï¼Œå¯†ç `Harbor12345` â†’ æˆåŠŸç™»å½• Harbor çš„ Web ç®¡ç†é¡µé¢ï¼›
2. åœ¨ Harbor ä¸­åˆ›å»ºé¡¹ç›®ã€ä¸Šä¼ é•œåƒï¼Œç„¶åç”¨ K8s (containerd) æ‹‰å–ï¼Œå®Œå…¨æ­£å¸¸ï¼

# âœ… å½»åº•æ¸…é™¤ Harbor æ‰€æœ‰å®‰è£…æ®‹ç•™æ–‡ä»¶ / é•œåƒ / å®¹å™¨ / æ•°æ®ï¼ˆä¸€é”®æ¸…ç©ºï¼Œå¹²å¹²å‡€å‡€ï¼Œæ— ä»»ä½•æ®‹ç•™ï¼‰

ä½ è¿™ä¸ªéœ€æ±‚å¤ªå¯¹äº†ï¼æ—¢ç„¶ä¸æƒ³è£…äº†ï¼Œå°±**å½»åº•æ¸…ç†å¹²å‡€**ï¼ŒæŠŠ Harbor å®‰è£…è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ **å®¹å™¨ã€é•œåƒã€æŒ‚è½½ç›®å½•ã€é…ç½®æ–‡ä»¶ã€æ•°æ®å·ã€ç¼“å­˜** å…¨éƒ¨åˆ é™¤ï¼Œæ¸…ç†åç³»ç»Ÿå’Œæ²¡è£…è¿‡ Harbor ä¸€æ¨¡ä¸€æ ·ï¼Œæ— ä»»ä½•æ®‹ç•™åƒåœ¾ï¼Œæ‰€æœ‰å‘½ä»¤**ç›´æ¥å¤åˆ¶æŒ‰é¡ºåºæ‰§è¡Œå³å¯**ï¼Œä½ çš„ç›®å½•æ˜¯ `/opt/k8s/harbor/`ï¼Œæˆ‘éƒ½é€‚é…å¥½äº†ï¼

---

## âœ… é‡è¦è¯´æ˜

æœ¬æ¬¡æ¸…ç†ä¼šåˆ é™¤ï¼š

1. Harbor æ‰€æœ‰è¿è¡Œ / åœæ­¢çš„å®¹å™¨ï¼ˆharbor-core/registry/postgres/redis ç­‰å…¨éƒ¨ï¼‰
2. Harbor æ‰€æœ‰ç›¸å…³é•œåƒï¼ˆgoharbor å¼€å¤´çš„å…¨éƒ¨é•œåƒï¼‰
3. Harbor å®‰è£…ç›®å½• `/opt/k8s/harbor/` ä¸‹**æ‰€æœ‰æ–‡ä»¶ + æ–‡ä»¶å¤¹**ï¼ˆé…ç½®ã€è¿ç§»è„šæœ¬ã€æ•°æ®ã€æ—¥å¿—ï¼‰
4. Docker ä¸­ Harbor ç›¸å…³çš„æ— åæ•°æ®å·ã€ç¼“å­˜ã€ç½‘ç»œ
5. æ— å…¶ä»–ç³»ç»Ÿæ–‡ä»¶å½±å“ï¼Œå®‰å…¨æ— é£é™©

---

## âœ… ã€ä¸€é”®å®Œæ•´ç‰ˆ æ¸…ç†å‘½ä»¤ã€‘æŒ‰é¡ºåºæ‰§è¡Œï¼Œä¸€æ­¥åˆ°ä½ï¼ˆæ¨èï¼‰

bash

è¿è¡Œ

```
# ============ ç¬¬ä¸€æ­¥ï¼šå¼ºåˆ¶åœæ­¢+åˆ é™¤æ‰€æœ‰Harborç›¸å…³å®¹å™¨ï¼ˆåŒ…æ‹¬å´©æºƒ/é‡å¯ä¸­çš„å®¹å™¨ï¼‰ ============
docker stop $(docker ps -a | grep -E "harbor-|goharbor|postgres|redis" | awk '{print $1}') 2>/dev/null
docker rm -f $(docker ps -a | grep -E "harbor-|goharbor|postgres|redis" | awk '{print $1}') 2>/dev/null

# ============ ç¬¬äºŒæ­¥ï¼šåˆ é™¤æ‰€æœ‰Harborç›¸å…³é•œåƒï¼ˆgoharborå¼€å¤´çš„å…¨éƒ¨ï¼Œå½»åº•é‡Šæ”¾ç£ç›˜ï¼‰ ============
docker rmi -f $(docker images | grep goharbor | awk '{print $3}') 2>/dev/null

# ============ ç¬¬ä¸‰æ­¥ï¼šåˆ é™¤Dockerä¸­Harborçš„æ— åæ•°æ®å·/ç¼“å­˜å·ï¼ˆæœ€å®¹æ˜“é—æ¼çš„æ®‹ç•™ï¼‰ ============
docker volume prune -f

# ============ ç¬¬å››æ­¥ï¼šåˆ é™¤Dockerä¸­Harboråˆ›å»ºçš„è‡ªå®šä¹‰ç½‘ç»œ ============
docker network rm harbor 2>/dev/null

# ============ ç¬¬äº”æ­¥ï¼šå½»åº•åˆ é™¤Harborçš„å®‰è£…ç›®å½•+æ‰€æœ‰æ•°æ®ï¼ˆæ ¸å¿ƒæ¸…ç†ï¼Œä½ çš„éƒ¨ç½²ç›®å½•ï¼‰ ============
rm -rf /opt/k8s/harbor/

# ============ ç¬¬å…­æ­¥ï¼šæ¸…ç†Dockerå¤±æ•ˆé•œåƒ/å®¹å™¨/ç¼“å­˜ï¼ˆç³»ç»Ÿçº§æ¸…ç†ï¼Œé‡Šæ”¾æ›´å¤šç£ç›˜ï¼‰ ============
docker system prune -a -f
```

---

## âœ… ã€éªŒè¯æ¸…ç†ç»“æœã€‘æ‰§è¡Œå®Œä¸Šé¢å‘½ä»¤åï¼Œæ‰§è¡Œä¸‹é¢ 2 æ¡å‘½ä»¤ï¼Œæ— è¿”å›ç»“æœ = æ¸…ç†å¹²å‡€

bash

è¿è¡Œ

```
# 1. æŸ¥çœ‹æ˜¯å¦è¿˜æœ‰harborç›¸å…³å®¹å™¨ï¼Œæ— è¾“å‡º=å¹²å‡€
docker ps -a | grep harbor

# 2. æŸ¥çœ‹æ˜¯å¦è¿˜æœ‰goharborç›¸å…³é•œåƒï¼Œæ— è¾“å‡º=å¹²å‡€
docker images | grep goharbor
```

---

## âœ… è¡¥å……ï¼šå¦‚æœä¸Šé¢å‘½ä»¤æ‰§è¡Œåè¿˜æœ‰å°‘é‡æ®‹ç•™ï¼ˆæå°‘æƒ…å†µï¼‰ï¼Œæ‰§è¡Œè¿™æ¡å…œåº•å‘½ä»¤

bash

è¿è¡Œ

```
# å…œåº•æ¸…ç†ï¼šåˆ é™¤æ‰€æœ‰dockerå®¹å™¨+é•œåƒï¼ˆè°¨æ…ï¼ä»…å½“ä½ dockeré‡Œæ²¡æœ‰å…¶ä»–é‡è¦é•œåƒ/å®¹å™¨æ—¶æ‰§è¡Œï¼‰
docker stop $(docker ps -a -q) 2>/dev/null && docker rm -f $(docker ps -a -q) 2>/dev/null && docker rmi -f $(docker images -q) 2>/dev/null && docker volume prune -f && docker network prune -f
```

æ˜¯çš„ï¼ŒK8s ä½¿ç”¨çš„ containerd éœ€è¦é…ç½®ä¿¡ä»»ä½ çš„ç§æœ‰ Harborï¼ˆå°¤å…¶æ˜¯è‡ªç­¾è¯ä¹¦åœºæ™¯ï¼‰ï¼Œå¦åˆ™æ‹‰å–é•œåƒæ—¶ä¼šæŠ¥è¯ä¹¦æˆ–ä»“åº“ä¸å¯ä¿¡çš„é”™è¯¯ã€‚ä»¥ä¸‹æ˜¯å…·ä½“é…ç½®æ­¥éª¤ï¼š
æ­¥éª¤ 1ï¼šå‡†å¤‡ Harbor çš„ CA è¯ä¹¦ï¼ˆè‡ªç­¾åœºæ™¯å¿…åšï¼‰
å¦‚æœä½ çš„ Harbor ç”¨çš„æ˜¯è‡ªç­¾è¯ä¹¦ï¼Œå…ˆä» Harbor æœåŠ¡å™¨è·å– CA æ ¹è¯ä¹¦ï¼ˆé€šå¸¸åœ¨ Harbor éƒ¨ç½²ç›®å½•çš„cert/ä¸‹ï¼Œæ¯”å¦‚/opt/k8s/harbor/cert/ca.crtï¼‰ã€‚
æ­¥éª¤ 2ï¼šåœ¨æ‰€æœ‰ K8s èŠ‚ç‚¹é…ç½® containerd çš„è¯ä¹¦ä¿¡ä»»
åœ¨æ¯ä¸ª K8s èŠ‚ç‚¹ä¸Šï¼Œä¸º Harbor åˆ›å»ºè¯ä¹¦ç›®å½•å¹¶å¤åˆ¶ CA è¯ä¹¦ï¼š
bash
è¿è¡Œ

# æ›¿æ¢ä¸ºä½ çš„Harboråœ°å€ï¼ˆæ¯”å¦‚harbor.example.com:8080ï¼‰

HARBOR_ADDR="ä½ çš„HarborIP:ç«¯å£"

# åˆ›å»ºcontainerdçš„è¯ä¹¦ç›®å½•

sudo mkdir -p /etc/containerd/certs.d/${HARBOR_ADDR}

# å¤åˆ¶Harborçš„CAè¯ä¹¦åˆ°è¯¥ç›®å½•ï¼ˆä»HarboræœåŠ¡å™¨æ‹·è´ca.crtåˆ°èŠ‚ç‚¹ï¼‰

sudo cp /path/åˆ°/harborçš„ca.crt /etc/containerd/certs.d/${HARBOR_ADDR}/ca.crt
æ­¥éª¤ 3ï¼šä¿®æ”¹ containerd çš„é…ç½®æ–‡ä»¶ï¼ˆconfig.tomlï¼‰
ç¼–è¾‘ containerd çš„ä¸»é…ç½®æ–‡ä»¶ï¼ˆé»˜è®¤è·¯å¾„ï¼š/etc/containerd/config.tomlï¼‰ï¼š
bash
è¿è¡Œ
sudo vim /etc/containerd/config.toml
åœ¨æ–‡ä»¶ä¸­æ·»åŠ  / ä¿®æ”¹registry é…ç½®æ®µï¼ˆæ›¿æ¢ä½ çš„HarborIP:ç«¯å£ï¼‰ï¼š
toml
[
plugins."io.containerd.grpc.v1.cri".registry
]
configs = {
"ä½ çš„HarborIP:ç«¯å£" = {
auth = {},
tls = {
ca_file = "/etc/containerd/certs.d/ä½ çš„HarborIP:ç«¯å£/ca.crt"  # æŒ‡å‘åˆšæ‰çš„CAè¯ä¹¦
}
}
}
å¦‚æœä½ çš„ Harbor æ˜¯HTTP åè®®ï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰ï¼Œåˆ™é…ç½®ä¸ºinsecure_registriesï¼ˆç”Ÿäº§ä¸å»ºè®®ï¼‰ï¼š
toml
[
plugins."io.containerd.grpc.v1.cri".registry
]
insecure_registries = ["ä½ çš„HarborIP:ç«¯å£"]  # å…è®¸ä¸å®‰å…¨çš„HTTPä»“åº“
æ­¥éª¤ 4ï¼šé‡å¯ containerd å’Œ kubelet æœåŠ¡
é…ç½®ç”Ÿæ•ˆéœ€è¦é‡å¯æœåŠ¡ï¼š
bash
è¿è¡Œ

# é‡å¯containerd

sudo systemctl restart containerd

# é‡å¯kubeletï¼ˆK8sèŠ‚ç‚¹ä¾èµ–containerdï¼‰

sudo systemctl restart kubelet
æ­¥éª¤ 5ï¼šéªŒè¯é…ç½®
åœ¨ K8s èŠ‚ç‚¹ä¸Šå°è¯•æ‹‰å– Harbor ä¸­çš„é•œåƒï¼ˆæ¯”å¦‚å…ˆæ¨ä¸€ä¸ªæµ‹è¯•é•œåƒåˆ° Harborï¼‰ï¼š
bash
è¿è¡Œ

# æ‹‰å–Harborä¸­çš„é•œåƒï¼ˆæ›¿æ¢ä¸ºä½ çš„é•œåƒåï¼‰

crictl pull ä½ çš„HarborIP:ç«¯å£/é¡¹ç›®å/é•œåƒå:æ ‡ç­¾
